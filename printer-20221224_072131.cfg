# MKS Gen l V1

[include mainsail.cfg]
[include Adaptive_Mesh.cfg]
[include Adaptive_Purge.cfg]
#[include pico_adxl345.cfg]
[exclude_object]

[stepper_x]
step_pin: PF0
dir_pin: !PF1
enable_pin: !PD7
microsteps: 16
rotation_distance = 39.9488 #200 * 16 * 0.012484
endstop_pin:^PE5 #X-Min, PE4:X-Max
position_endstop: 0
#231022
position_max: 220
homing_speed: 80

[stepper_y]
step_pin: PF6
dir_pin: !PF7
enable_pin: !PF2
microsteps: 16
rotation_distance = 40.0736 #200 * 16 * 0.012523
endstop_pin: ^PJ1  #Y-Min, PJ0:Y-Max
position_endstop: 0
#231022
position_max: 218
homing_speed: 80

[stepper_z]
step_pin: PL3
dir_pin: PL1
enable_pin: !PK0
microsteps: 16
rotation_distance = 7.9616 #200 * 16 * 0.002488
endstop_pin: ^PD3  #Z-Min, PD2:Z-Max
#231022
position_max: 200
position_min: -3
endstop_pin: probe:z_virtual_endstop

[extruder]
step_pin: PA4
dir_pin: !PA6
enable_pin: !PA2
microsteps: 16
rotation_distance = 8.1056 #200 * 16 * 0.002533 (seems a bit low...other direct extruders are 20+!)
nozzle_diameter: 0.6
filament_diameter: 1.750
heater_pin: PB4
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PK5
min_temp: 0
max_temp: 300
#pressure_advance: 0.07825
# 280922
#pressure_advance: 0.023
# 201022 - using https://github.com/AndrewEllis93/Print-Tuning-Guide/blob/main/articles/pressure_advance.md#lines-method
#pressure_advance: 0.035 # will now load this via Superslicer Filament GCODE
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
#Added 141022
max_extrude_only_distance: 500.0

[heater_bed]
heater_pin: PH5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PK6
min_temp: 0
max_temp: 130
#control: pid
#pid_Kp: 325.10
#pid_Ki: 63.35
#pid_Kd: 417.10

[fan]
pin: PH6

[heater_fan nozzle_fan]
pin: PH4
heater: extruder
heater_temp: 50.0
fan_speed: 1

[temperature_sensor raspberry_pi]
sensor_type: temperature_host

[mcu]
serial: /dev/serial0

[input_shaper]
#160922
#shaper_freq_x: 42.8
#shaper_type_x: 2hump_ei
#shaper_freq_y: 26.4
#shaper_type_y: mzv
#301022
shaper_freq_x: 42.6
shaper_type_x: 2hump_ei
shaper_freq_y: 27.0
shaper_type_y: mzv


[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 1800
max_accel_to_decel: 1800
max_z_velocity: 10
max_z_accel: 500
square_corner_velocity: 10.0

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC0, EXP1_3=PH0, EXP1_5=PA1, EXP1_7=PA5, EXP1_9=<GND>,
    EXP1_2=PC2, EXP1_4=PH1, EXP1_6=PA3, EXP1_8=PA7, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PB3, EXP2_3=PC6, EXP2_5=PC4, EXP2_7=PL0,  EXP2_9=<GND>,
    EXP2_2=PB1, EXP2_4=PB0, EXP2_6=PB2, EXP2_8=PG0, EXP2_10=<NC>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp1"
# See the MKS Lcd Config path file for definitions of common LCD displays.

# "RepRapDiscount 128x64 Full Graphic Smart Controller" type displays
[display]
lcd_type: st7920
cs_pin: EXP1_4
sclk_pin: EXP1_5
sid_pin: EXP1_3
encoder_pins: ^EXP2_3, ^EXP2_5
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8

[virtual_sdcard]
path: ~/gcode_files

[pause_resume]

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE


[display_status]

[bltouch]
sensor_pin: ^PD3
control_pin:PB5
x_offset: 47.6
y_offset: -4.8
# PROBE_CALIBRATE update:
# - IMPORTANT 
#    - make sure the BLTouch offsets have been set and saved in the config file 
#    - make sure the bed AND nozzle is squeaky CLEAN 
#    - test with the bed and nozzle at ROOM TEMP
#    - test bed with a zigzag cigarette paper
# - use testz to find the z offset
# - place paper under hotend
# - TESTZ Z=-1.0 until zigzag paper can't move freely
# - when happy issue
#   - ACCEPT
#- note down the z value and add '0.2' eg. 2.165 becomes 2.365
# kxd 150918 - tuned for my z endstop
# ++ = close -- = far eg. If 3.0 is too close make it 2.5
z_offset = 2.029
speed: 10.0
samples: 1
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.1
samples_tolerance_retries: 1

[safe_z_home]
home_xy_position: 110,110 # Change coordinates to the center of your print bed
speed: 80
z_hop: 5                  # Move up 10mm
z_hop_speed: 5


[gcode_macro bed_mesh_cali]
gcode:
    BED_MESH_CLEAR
    G28
    BED_MESH_CALIBRATE
    BED_MESH_PROFILE SAVE=name
    SAVE_CONFIG
    BED_MESH_PROFILE LOAD=name

[bed_mesh]
speed: 500
horizontal_move_z: 6
mesh_min:50,20
mesh_max:210,210
probe_count: 5,5

[screws_tilt_adjust]
screw1: 0.1, 36
screw1_name: front left screw
screw2: 155.1, 36
screw2_name: front right screw
screw3: 155.1, 206
screw3_name: rear right screw
screw4: 0.1, 206
screw4_name: rear left screw
horizontal_move_z: 10.
speed: 50.
screw_thread: CW-M3

[gcode_macro home_c]
gcode:
  G91
  G28
  G90
  
[gcode_macro PLA_Hotend]
gcode:
  M104 T0 S200

[gcode_macro PLA_Bed]
gcode:
  M140 S60  

[gcode_macro Bltouch_self_release]
gcode:  
    BLTOUCH_DEBUG COMMAND=reset  
 
 # Added 080922
[gcode_macro PRINT_START]
gcode:        
    # Parameters
    {% set bedtemp = params.BED|int %}
    {% set hotendtemp = params.HOTEND|int %}

    M80                             ; Turn on PSU
        
    G90                             ; use absolute coordinates
    M83                             ; extruder relative mode
    
    M140 S{bedtemp}                 ; set final bed temp
    M104 S150                       ; set temporary nozzle temp to prevent oozing during homing
    
    G4 S10                          ; allow partial nozzle warmup
    G28                             ; home all axis

    BED_MESH_CALIBRATE

    ; Makers Mashup Startup GCode Generator (C) 2022 - Robert Mech
    ; Generated at Fri Oct 14 2022 by https://www.layerfused.com/3d-printer-calibration
    
    ; Kiss Generation
    G0 X68 Y0 Z25 F5000		        ; Move to position

    M104 S{hotendtemp}              ; set final nozzle temp
    M190 S{bedtemp}                 ; set & wait for bed temp to stabilise
    M109 S{hotendtemp}              ; set &  wait for nozzle temp to stabilise

    G92 E0					        ; Reset Extruder
    G1 E80 F300				        ; Extrude a kiss
    G0 X28 Y0 Z0 F1000		        ; Wipe 
    G0 X43 Y0 Z0 F1000		        ; Wipe 
    G0 X28 Y5 Z-0.1 F700            ; Wipe 
    G0 X43 Y5 Z-0.1 F700	        ; Wipe 
    G0 X28 Y10 Z0.2 F1000	        ; Wipe 
    G0 X28 Y10 Z0.2 F1000	        ; Wipe 
    G0 Z0.2 E-1.5 F300              ; Retract 
    #G0 X117.5 Y117.5 Z4	F5000		; Return to center of bed

    ; Footer - Reset extruder and go to absolute extrusion mode
    G92 E0                          ; Reset Extruder
    G90                             ; Reset Absolute Positioning
    G0 Z4 F400                      ; Move down just a bit
        
 # Added 080922
[gcode_macro PRINT_END]
gcode:        
    
    G91                             ; relative mode
    G1 Z10 F6000                    ; move print head up 10mm medium speed
    
    G90                             ; use absolute coordinates

    G1 Y200 F6000                   ; present print medium speed

    M140 S0                         ; turn off heatbed
    M104 S0                         ; turn off temperature
    M107                            ; turn off fan
    M84 X Y E                       ; disable motors

[idle_timeout]
timeout: 240
gcode:
  MACHINE_IDLE_TIMEOUT

# Turn on PSU
[gcode_macro M80]
gcode:
  # Moonraker action
  {action_call_remote_method('set_device_power',
                             device='Printer',
                             state='on')}

# Turn off PSU
[gcode_macro M81]
gcode:
  # Moonraker action
  {action_call_remote_method('set_device_power',
                             device='Printer',
                             state='off')}

[gcode_macro MACHINE_IDLE_TIMEOUT]
gcode:
	M84
  TURN_OFF_HEATERS
  M81

    # Set time out duration in seconds to turn printer off
    #UPDATE_DELAYED_GCODE ID=delayed_printer_off DURATION=240


[gcode_macro LOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    M300 # beep
    G91
    G92 E0
    G1 E150 F{max_velocity}
    G1 E5 F{speed} #purge
    M300
    M300

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    G91
    M300 # beep
    G92 E0
    G1 E5 F{speed} # purge
    G1 E-100 F{max_velocity}
    M300
    M300

[gcode_macro PURGE]
gcode:
    G91
    G1 E100 F300
    G90

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.111960, 0.106984, 0.062200, -0.019904, -0.171672
#*# 	  0.097032, 0.079616, 0.027368, -0.184112, -0.268704
#*# 	  0.121912, 0.099520, 0.052248, -0.047272, -0.079616
#*# 	  0.159232, 0.099520, 0.064688, -0.002488, -0.044784
#*# 	  0.126888, 0.136840, 0.156744, 0.022392, -0.022392
#*# tension = 0.2
#*# min_x = 50.0
#*# algo = lagrange
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 20.009999999999998
#*# x_count = 5
#*# max_y = 210.0
#*# mesh_x_pps = 2
#*# max_x = 210.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.987
#*# pid_ki = 1.118
#*# pid_kd = 151.049
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.136
#*# pid_ki = 1.482
#*# pid_kd = 672.399
#*#
#*# [bltouch]
#*#
#*# [bed_mesh name]
#*# version = 1
#*# points =
#*# 	0.042296, 0.077128, 0.047272
#*# 	-0.004976, 0.017416, -0.047272
#*# 	-0.092056, 0.131864, 0.126888
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 210.0
#*# min_y = 20.009999999999998
#*# max_y = 210.0
