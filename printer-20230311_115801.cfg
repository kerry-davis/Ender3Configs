# MKS Gen l V1

[include mainsail.cfg]
[include Adaptive_Mesh.cfg]
[include Adaptive_Purge.cfg]
#[include pico_adxl345.cfg]
[include neopixel.cfg]
[exclude_object]

[stepper_x]
step_pin: PF0
dir_pin: !PF1
enable_pin: !PD7
microsteps: 16
rotation_distance = 39.9488 #200 * 16 * 0.012484
endstop_pin:^PE5 #X-Min, PE4:X-Max
position_endstop: 0
#231022
position_max: 220
homing_speed: 80

[stepper_y]
step_pin: PF6
dir_pin: !PF7
enable_pin: !PF2
microsteps: 16
rotation_distance = 40.0736 #200 * 16 * 0.012523
endstop_pin: ^PJ1  #Y-Min, PJ0:Y-Max
position_endstop: 0
#231022
position_max: 218
homing_speed: 80

[stepper_z]
step_pin: PL3
dir_pin: PL1
enable_pin: !PK0
microsteps: 16
rotation_distance = 7.9616 #200 * 16 * 0.002488
endstop_pin: ^PD3  #Z-Min, PD2:Z-Max
#231022
position_max: 200
position_min: -3
endstop_pin: probe:z_virtual_endstop

[extruder]
step_pin: PA4
dir_pin: PA6
enable_pin: !PA2
microsteps: 16
#rotation_distance = 8.1056 #200 * 16 * 0.002533 (seems a bit low...other direct extruders are 20+!)
rotation_distance: 4.682                                           # Added voron pancake stepper 070323 - See calibrating rotation_distance on extruders doc
nozzle_diameter: 0.6
filament_diameter: 1.750
heater_pin: PB4
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PK5
min_temp: 0
max_temp: 300
#pressure_advance: 0.07825
# 280922
#pressure_advance: 0.023
# 201022 - using https://github.com/AndrewEllis93/Print-Tuning-Guide/blob/main/articles/pressure_advance.md#lines-method
#pressure_advance: 0.035 # will now load this via Superslicer Filament GCODE
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
#Added 141022
max_extrude_only_distance: 500.0
#run_current: 0.581 - this is the voltage manually measured for the new voron pancake stepper 04.03.23

[heater_bed]
heater_pin: PH5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PK6
min_temp: 0
max_temp: 130
#control: pid
#pid_Kp: 325.10
#pid_Ki: 63.35
#pid_Kd: 417.10

[fan]
pin: PH6

[heater_fan nozzle_fan]
pin: PH4
heater: extruder
heater_temp: 50.0
fan_speed: 1

[temperature_sensor raspberry_pi]
sensor_type: temperature_host

[mcu]
serial: /dev/serial0

[input_shaper]
#160922
#shaper_freq_x: 42.8
#shaper_type_x: 2hump_ei
#shaper_freq_y: 26.4
#shaper_type_y: mzv
#301022
#shaper_freq_x: 42.6
#shaper_type_x: 2hump_ei
#shaper_freq_y: 27.0
#shaper_type_y: mzv


[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 1800
max_accel_to_decel: 1800
max_z_velocity: 10
max_z_accel: 500
square_corner_velocity: 10.0

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC0, EXP1_3=PH0, EXP1_5=PA1, EXP1_7=PA5, EXP1_9=<GND>,
    EXP1_2=PC2, EXP1_4=PH1, EXP1_6=PA3, EXP1_8=PA7, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PB3, EXP2_3=PC6, EXP2_5=PC4, EXP2_7=PL0,  EXP2_9=<GND>,
    EXP2_2=PB1, EXP2_4=PB0, EXP2_6=PB2, EXP2_8=PG0, EXP2_10=<NC>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp1"
# See the MKS Lcd Config path file for definitions of common LCD displays.

# "RepRapDiscount 128x64 Full Graphic Smart Controller" type displays
[display]
lcd_type: st7920
cs_pin: EXP1_4
sclk_pin: EXP1_5
sid_pin: EXP1_3
encoder_pins: ^EXP2_3, ^EXP2_5
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8

[virtual_sdcard]
path: ~/gcode_files

[pause_resume]

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  _STATUS_OFF
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE

[display_status]

[bltouch]
sensor_pin: ^PD3
control_pin:PB5
#070323 new offsets using voron miniSB
#x_offset = 34.8
x_offset: -35.6
y_offset = 0
#x_offset: 47.6
#y_offset: -4.8
# PROBE_CALIBRATE update:
# - IMPORTANT 
#    - make sure the BLTouch offsets have been set and saved in the config file 
#    - make sure the bed AND nozzle is squeaky CLEAN 
#    - test with the bed and nozzle at ROOM TEMP
#    - test bed with a zigzag cigarette paper
# - use testz to find the z offset
# - place paper under hotend
# - TESTZ Z=-1.0 until zigzag paper can't move freely
# - when happy issue
#   - ACCEPT
#- note down the z value and add '0.2' eg. 2.165 becomes 2.365
# kxd 150918 - tuned for my z endstop
# ++ = close -- = far eg. If 3.0 is too close make it 2.5
#z_offset = 2.029
speed: 10.0
samples: 1
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.1
samples_tolerance_retries: 1

[bed_mesh]
speed: 500
horizontal_move_z: 6
mesh_min:10,15
mesh_max:183,210
probe_count: 5,5
fade_start: 1
fade_end: 10
fade_target: 0
mesh_pps: 2, 2
algorithm: bicubic
bicubic_tension: 0.2

[safe_z_home]
home_xy_position: 110,110 # Change coordinates to the center of your print bed
speed: 80
z_hop: 5                  # Move up 10mm
z_hop_speed: 5

[gcode_macro bed_mesh_cali]
gcode:
    BED_MESH_CLEAR
    _STATUS_HOMING
    G28
    _STATUS_MESHING
    BED_MESH_CALIBRATE
    BED_MESH_PROFILE SAVE=name
    SAVE_CONFIG
    BED_MESH_PROFILE LOAD=name

[screws_tilt_adjust]
screw1: 0.1, 36
screw1_name: front left screw
screw2: 155.1, 36
screw2_name: front right screw
screw3: 155.1, 206
screw3_name: rear right screw
screw4: 0.1, 206
screw4_name: rear left screw
horizontal_move_z: 10.
speed: 50.
screw_thread: CW-M3

[gcode_macro home_c]
gcode:
  G91
  _STATUS_HOMING
  G28
  G90
  
[gcode_macro PLA_Hotend]
gcode:
  M104 T0 S200

[gcode_macro PLA_Bed]
gcode:
  M140 S60  

[gcode_macro Bltouch_self_release]
gcode:  
    BLTOUCH_DEBUG COMMAND=reset  
 
 # Added 080922
[gcode_macro PRINT_START]
gcode:        
    # Parameters
    {% set bedtemp = params.BED|int %}
    {% set hotendtemp = params.HOTEND|int %}

    _STATUS_READY

    M80                             ; Turn on PSU
        
    G90                             ; use absolute coordinates
    M83                             ; extruder relative mode
    
    M140 S{bedtemp}                 ; set final bed temp
    M104 S150                       ; set temporary nozzle temp to prevent oozing during homing
    
    G4 S10                          ; allow partial nozzle warmup
    _STATUS_HOMING
    G28                             ; home all axis

    _STATUS_MESHING
    BED_MESH_CALIBRATE

    ; Makers Mashup Startup GCode Generator (C) 2022 - Robert Mech
    ; Generated at Fri Oct 14 2022 by https://www.layerfused.com/3d-printer-calibration
    
    ; Kiss Generation
    G0 X68 Y0 Z25 F5000		        ; Move to position

    _STATUS_HEATING
    M104 S{hotendtemp}              ; set final nozzle temp
    M190 S{bedtemp}                 ; set & wait for bed temp to stabilise
    M109 S{hotendtemp}              ; set &  wait for nozzle temp to stabilise

    G92 E0					        ; Reset Extruder
    G1 E80 F300				        ; Extrude a kiss
    G0 X38 Y0 Z0 F1000		        ; Wipe 
    G0 X43 Y0 Z0 F1000		        ; Wipe 
    G0 X38 Y5 Z-0.1 F700            ; Wipe 
    G0 X43 Y5 Z-0.1 F700	        ; Wipe 
    G0 X38 Y10 Z0.2 F1000	        ; Wipe 
    G0 X38 Y10 Z0.2 F1000	        ; Wipe 
    G0 Z0.2 E-1.5 F300              ; Retract 
    #G0 X117.5 Y117.5 Z4	F5000		; Return to center of bed

    ; Footer - Reset extruder and go to absolute extrusion mode
    G92 E0                          ; Reset Extruder
    G90                             ; Reset Absolute Positioning
    G0 Z4 F400                      ; Move down just a bit

    _STATUS_PRINTING

        
 # Added 080922
[gcode_macro PRINT_END]
gcode:        
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    #G1 E-4.0 F3600                ; retract filament
    G91                            ; relative positioning

    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    #   Check end position to determine safe direction to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 2) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    G0 Z{z_safe} F3600             ; move nozzle up
    G0 X{x_safe} Y{y_safe} F20000  ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G90                            ; absolute positioning
    G0 X110 Y{max_y} F3600          ; park nozzle at rear
    M84 X Y E                       ; disable motors
    _STATUS_OFF


[idle_timeout]
timeout: 240
gcode:
  MACHINE_IDLE_TIMEOUT

# Turn on PSU
[gcode_macro M80]
gcode:
  # Moonraker action
  {action_call_remote_method('set_device_power',
                             device='Printer',
                             state='on')}

# Turn off PSU
[gcode_macro M81]
gcode:
  # Moonraker action
  {action_call_remote_method('set_device_power',
                             device='Printer',
                             state='off')}

[gcode_macro MACHINE_IDLE_TIMEOUT]
gcode:
	M84
  TURN_OFF_HEATERS
  M81

    # Set time out duration in seconds to turn printer off
    #UPDATE_DELAYED_GCODE ID=delayed_printer_off DURATION=240


[gcode_macro LOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    M300 # beep
    G91
    G92 E0
    G1 E150 F{max_velocity}
    G1 E5 F{speed} #purge
    M300
    M300

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    G91
    M300 # beep
    G92 E0
    G1 E5 F{speed} # purge
    G1 E-100 F{max_velocity}
    M300
    M300

[gcode_macro PURGE]
gcode:
    G91
    G1 E100 F300
    G90


[gcode_macro ROTATION_DIST_50mm]
gcode:
    G91
    G1 E50 F60
    G90

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.987
#*# pid_ki = 1.118
#*# pid_kd = 151.049
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.136
#*# pid_ki = 1.482
#*# pid_kd = 672.399
#*#
#*# [bltouch]
#*# z_offset = 2.752
#*#
#*# [input_shaper]
#*# shaper_type_x = 3hump_ei
#*# shaper_freq_x = 73.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 25.6
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.288608, 0.179136, 0.243824, 0.298560, 0.584680
#*# 	0.475208, 0.268704, 0.315976, 0.328416, 0.440376
#*# 	0.303536, 0.176648, 0.151768, 0.186600, 0.325928
#*# 	0.243824, 0.114448, 0.104496, 0.171672, 0.308512
#*# 	0.161720, 0.084592, 0.102008, 0.119424, 0.291096
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 10.0
#*# max_x = 183.0
#*# min_y = 15.0
#*# max_y = 210.0
#*#
#*# [bed_mesh name]
#*# version = 1
#*# points =
#*# 	0.007464, 0.074640, 0.072152, 0.039808, 0.139328
#*# 	-0.087080, -0.017416, -0.000000, -0.062200, 0.007464
#*# 	-0.261240, -0.129376, 0.002488, 0.002488, 0.144304
#*# 	-0.276168, -0.169184, -0.047272, 0.002488, 0.092056
#*# 	-0.335880, -0.179136, -0.067176, -0.057224, 0.042296
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 210.0
#*# min_y = 20.0
#*# max_y = 210.0
